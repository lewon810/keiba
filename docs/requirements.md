# System Requirements

## Overview
The application is a horse racing prediction system consisting of two main components: `prediction` and `learn`.

## Rule
- チャットには日本語で応答してください。
- python実行時はvenv上で実行することを忘れないでください。
- 実行しているOSを確認し、Windowsの場合はPowerShellを利用してください。
- コードに修正を加える際、README.mdの更新が必要か確認してください。
- ディレクトリやファイル名を変更した場合はREADME更新とtestがPASSすることを確認してください。
- コードに修正を加える際、以下のソースコードの動作を保証するようにtestを実行・更新してください。
    - `train/evaluate_model.py`
    - `train/evaluate.py`
    - `train/preprocess.py`
    - `train/train.py`
    - `app/scraper.py`
    - `app/predictor.py`
    - `app/main.py`  

## Architecture

### 1. Prediction (Inference & UI) - `app/`
- **Role**: Main user interface for end-users.
- **Functionality**:
    - Accepts Netkeiba race URL as input.
    - Scrapes race data (horses, jockeys, etc.) from the URL.
    - Loads the trained model/data generated by the `train` component.
    - Outputs prediction results.
- **Current Status**: Implemented in `app/` (scraper + basic GUI).

### 2. Learn (Machine Learning) - `train/`
- **Role**: Model training and data construction.
- **Functionality**:
    - Implements machine learning logic based on the theory described in `docs/競馬予測論文の探索と解説.docx`.
    - **Algorithm**: LightGBM (Multi-class classification: Winner, Placed, Board, Lost).
    - **Features**: Speed Index (standardized), Target Encoding (Jockey/Sire), Lag features (past performance), Contextual features.
    - **Strategy**: "Power of 4" (Score = $P^4 \times Odds$).
    - **Data Source**: Netkeiba historical data (bulk scraping required).
    - **Validation**: Time-series split (Train -> Valid -> Test).
    - constructs training data.
    - Outputs a trained model or reference data for the `prediction` component.
- **Theory Source**: `docs/競馬予測論文の探索と解説.docx`

## Directory Structure
```
keiba/
├── docs/               # Documentation & Requirements
├── app/                # Main App (Inference & UI)
├── train/              # ML Logic & Training Scripts
│   ├── scraper.py      # Bulk scraper for training data
│   ├── preprocess.py   # Feature engineering pipeline
│   ├── train.py        # LightGBM training script
│   └── data/           # Raw and processed data storage
└── README.md
```

## Detailed ML Requirements

### 1. Data Collection
- Source: Netkeiba.com
- Scope: Historical data (e.g., past 10 years).
- Tables: Race Info, Race Results, Horse Entries, Horse Details.

### 2. Feature Engineering
- **Target Variable**: `rank_class` (0: 1st, 1: 2-3rd, 2: 4-5th, 3: 6th+).
- **Key Features**:
    - **Speed Index**: Standardized time based on course/distance averages.
    - **Target Encoding**: Jockey win rates, Sire mud index (calculated using past data only to avoid leakage).
    - **Lag Features**: Previous race result, time, interval days, distance change.
    - **Categorical**: Horse ID, Jockey ID, Trainer ID (Label Encoded).

### 3. Model Training
- **Library**: `lightgbm`
- **Objective**: `multiclass` (num_class=4)
- **Metric**: `multi_logloss`
- **Validation**: Time-series split (no random shuffle).

### 4. Betting Strategy (Inference)
- **Score Calculation**: $Score = (Probability_{Win})^4 \times Odds$
- **Selection**: Filter horses with high scores as candidates.
