name: Learn and Evaluate

on:
  workflow_dispatch:
    inputs:
      train_start:
        description: 'Training Start Year'
        required: true
        default: '2016'
      train_end:
        description: 'Training End Year'
        required: true
        default: '2024'
      eval_year:
        description: 'Evaluation Year'
        required: true
        default: '2025'
      power_min:
        description: 'Min Score Exponent (Power)'
        required: true
        default: '3'
      power_max:
        description: 'Max Score Exponent (Power)'
        required: true
        default: '5'
      race_min:
        description: 'Min Race No (e.g. 9)'
        required: false
        default: '1'
      race_max:
        description: 'Max Race No (e.g. 12)'
        required: false
        default: '12'
  schedule:
    # Run weekly or so? User didn't specify schedule prefernce for this one.
    - cron: '0 0 * * 1' # Every Monday

jobs:
  evaluate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install matplotlib

    - name: Train Model
      # Assumes raw data is present in repo or cached. 
      # User stated: "Use CSVs in master branch raw folder".
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        # Use inputs if available (workflow_dispatch), otherwise defaults for schedule
        START=${{ inputs.train_start || '2016' }}
        END=${{ inputs.train_end || '2024' }}
        echo "Training from $START to $END"
        python -m train.train --start $START --end $END

    - name: Generate Evaluation Report
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        # Ensure report dir exists
        mkdir -p train/report
        EVAL_YEAR=${{ inputs.eval_year || '2025' }}
        P_MIN=${{ inputs.power_min || '3' }}
        P_MAX=${{ inputs.power_max || '5' }}
        R_MIN=${{ inputs.race_min || '1' }}
        R_MAX=${{ inputs.race_max || '12' }}
        echo "Evaluating on $EVAL_YEAR | Power $P_MIN-$P_MAX | Race $R_MIN-$R_MAX"
        python -m train.report.evaluate_html_generator --start $EVAL_YEAR --end $EVAL_YEAR --output evaluate.html --power_min $P_MIN --power_max $P_MAX --race_min $R_MIN --race_max $R_MAX

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-artifact
        path: evaluate.html
